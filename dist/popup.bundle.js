(()=>{"use strict";var e={5433:(e,t)=>{t.getEmojiForNodeId=function(e){const t=e.split("").reduce(((e,t)=>e+t.charCodeAt(0)),0)%n+1;return chrome.runtime.getURL(`images/${t}.gif`)};const n=500}},t={},n=function n(o){var r=t[o];if(void 0!==r)return r.exports;var i=t[o]={exports:{}};return e[o](i,i.exports,n),i.exports}(5433);console.log("Popup script attempting to load");try{console.log("Window object:",window),console.log("Document object:",document)}catch(e){console.error("Error during initial load:",e)}async function o(e,t){if(!t)throw new Error("tabId is required",e.type);return new Promise(((n,o)=>{chrome.tabs.sendMessage(t,{...e,tabId:t},(e=>{if(chrome.runtime.lastError)return o(chrome.runtime.lastError);n(e)}))}))}async function r(e,t){return o({type:"SELECT_NODE",nodeId:e},t)}async function i(e){return o({type:"GET_NODE_STATE"},e)}console.log("Popup script loading"),window.addEventListener("error",(e=>{console.error("Script error:",{message:e.error?.message,stack:e.error?.stack,source:e.filename,line:e.lineno,column:e.colno})})),document.addEventListener("DOMContentLoaded",(async()=>{console.log("DOM Content Loaded");const e=document.getElementById("createNode"),t=document.getElementById("goLive"),c=document.getElementById("nodeList");function a(e){return e?`${e.slice(0,4)}...${e.slice(-4)}`:"Not connected"}function d(e){if(!e)return"ðŸ‘»";const t=(0,n.getEmojiForNodeId)(e),o=document.createElement("img");return o.src=t,o.style.width="24px",o.style.height="24px",o.style.verticalAlign="middle",o.style.marginRight="7px",o.style.borderRadius="50%",o}async function s(e){const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});document.getElementById("tabId").innerText=n?n.id:"No tab";const o=document.getElementById("peerId");if(o.innerHTML="",e?.peerId){o.appendChild(d(e.peerId));const t=document.createElement("span");t.style.textDecoration="underline",t.textContent=a(e.peerId),o.appendChild(t)}else o.innerText="Not connected";document.getElementById("peers").innerText=e?.peers?.map(a).join(", ")||"None",document.getElementById("discoveryPeers").innerText=e?.discoveryPeers?.map(a).join(", ")||"None",document.getElementById("drpId").innerText=e?.drpId||"no live drp",e?.drpId?(t.classList.add("active"),t.innerText="LIVE"):(t.classList.remove("active"),t.innerText="GO LIVE")}async function l(e){const t=await async function(e){return o({type:"GET_NODES"},e)}(e);c.innerHTML="";for(const e of t.nodes){const n=document.createElement("div");n.className="node-item",e===t.activeNodeId&&n.classList.add("selected"),n.innerHTML="",n.appendChild(d(e)),n.appendChild(document.createTextNode(a(e))),n.addEventListener("click",(async()=>{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});await r(e,t.id),l(t.id);const n=await i(t.id);n&&!n.error&&s(n)})),c.appendChild(n)}}console.log("Elements found:",{createNodeButton:e,goLiveButton:t,nodeList:c}),e.addEventListener("click",(async()=>{console.log("Create node clicked");const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),t=await async function(e){return o({type:"CREATE_NODE"},e)}(e.id);if(console.log("Create node response:",t),t){if(t.error)console.error("Error creating node:",t.error);else if(t.nodeId){await l(e.id);const t=await i(e.id);t&&!t.error&&s(t)}}else console.error("No response received from background script")})),t.addEventListener("click",(async()=>{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});t.classList.contains("active")?(await async function(e){return o({type:"LEAVE_ROOM"},e)}(e.id),t.classList.remove("active"),t.innerText="GO LIVE"):(console.log("popup: attempt to go live"),await async function(e){return await o({type:"GO_LIVE"},e)}(e.id),setTimeout((async()=>{const t=await i(e.id);t&&s(t)}),500))}));try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});document.getElementById("tabId").innerText=e?e.id:"No tab",await l(e.id);const t=await i(e.id);await s(t||{})}catch(e){console.error("Error during initial setup:",e)}chrome.runtime.onMessage.addListener((async e=>{if("STATE_UPDATE"===e.type){const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});t.id===e.tabId&&(s(e.state),l())}}))})),window.addEventListener("error",(e=>{console.error("Uncaught error:",e.error)}))})();